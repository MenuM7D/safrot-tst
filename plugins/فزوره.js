import fetch from 'node-fetch';

const gameDuration = 60000; 
const basePoints = 500; 
const maxQuestions = 50; 
const maxHelps = 2;
const maxHints = 1; 
const maxResponses = 1; 
const maxReducedOptions = 1; 

const difficultyLevels = {
    easy: 1,
    medium: 2,
    hard: 3
}; 

const tips = [
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูู ุนูู ููุง ูุฑูุ', answer: 'ุงูุฅุจุฑุฉ' },
    { question: 'ูููุฉ ุชุชููู ูู 3 ุญุฑูู ุฅุฐุง ุฃุถูุช ุญุฑู ุชุตุจุญ ุฃูุจุฑุ', answer: 'ุงูููุฒุงู' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ููุณุฑ ูููู ูุง ููุนุ', answer: 'ุงูุฒุฌุงุฌ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ููุดู ุจูุง ุฃุฑุฌูุ', answer: 'ุงูุณุงุนุฉ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ููุชุจ ููุง ููุฑุฃุ', answer: 'ุงูููู' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุง ูููู ููุณู ููููู ููุฌูุฏุ', answer: 'ุงูููุงุก' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ููุงู ููุณุชููุธ ูู ููุณ ุงูููุชุ', answer: 'ุงูููู' },
    { question: 'ุดูุก ูุง ูุชููู ูุฅุฐุง ุฌุงุน ูุณูุน ุตูุชูุ', answer: 'ุงูุฌุฑุณ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุฒุฏุงุฏ ูููุง ุฃุฎุฐุช ูููุ', answer: 'ุงูุญูุฑุฉ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุฐูุจ ููุง ูุนูุฏุ', answer: 'ุงูููุช' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุชุณุน ููุถูู ูู ููุณ ุงูููุชุ', answer: 'ุงูููุงุจุณ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูููู ุฃุณูุงู ูููู ูุง ูุนุถุ', answer: 'ุงููุดุท' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุชุญุฑู ุญููู ููุง ุชุฑุงูุ', answer: 'ุงูุธู' },
    { question: 'ุดูุก ุฅุฐุง ุดุฑุจุชู ุชููุชุ', answer: 'ุงููุงุก ุงููุงูุญ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุฑูุน ููุง ููุดูุ', answer: 'ุงูุฑุงูุนุฉ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ููุชุจ ุจุฎุท ุฌููู ูููู ูุง ูุธูุฑุ', answer: 'ุงูุญูู' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุง ูุญุชุฑู ููุง ูุฐูุจุ', answer: 'ุงูุฌููุฏ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูู ููุจ ููุง ููุจุถุ', answer: 'ุงูุฎุดุจ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ุฅุฐุง ูุณุฑุชู ููุง ููููู ุฅุตูุงุญูุ', answer: 'ุงูุซูุฉ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ููููู ุฃู ุชุฃุฎุฐู ุฅูู ุงูููุฒู ูููู ููุณ ุญูููููุงุ', answer: 'ุงูุตูุฑุฉ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุง ููุงู ููู ูุณุชุฑูุญุ', answer: 'ุงูุจุญุฑ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ุนูุฏูุง ุชุถุนู ูู ุงููุงุก ูุง ูุจุชูุ', answer: 'ุงูุธู' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุชุบูุฑ ูููู ุญุณุจ ุงูููุงูุ', answer: 'ุงูุณูุงุก' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุจุฏุฃ ุตุบูุฑูุง ููููู ููุตุจุญ ูุจูุฑูุงุ', answer: 'ุงูุจุฐูุฑ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุญูู ุฃููุงููุง ูุซูุฑุฉ ูููู ูุจูู ุซุงุจุชูุงุ', answer: 'ุงูููุญุฉ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ููุถู ูููู ูู ุงูุณุทุญ ูููู ูุง ูุชูููุ', answer: 'ุงูุณุงุนุฉ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุง ูููู ุฑุคูุชู ูู ุงูููุงุฑุ', answer: 'ุงูููุฑ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุฃุชู ุจุนุฏ ุงููุฑุญุ', answer: 'ุงูุญุฒู' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุชูุฏู ูููู ูุง ูุนูุฏุ', answer: 'ุงูููุช' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูู ุฌูุจู ููููู ุฃูุจุฑ ูู ุฌูุจูุ', answer: 'ุงูููุทุฉ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุง ููุชูู ููุจูุง ููุน ุฐูู ูุญุจุ', answer: 'ุงูุญุจ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุฎุชูู ุนูุฏูุง ุชุชุญุฏุซ ุนููุ', answer: 'ุงูุตูุช' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุณูุฑ ุฏูู ุฃู ูุชุญุฑูุ', answer: 'ุงูุณุงุนุฉ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุณูุน ุจูุง ุฃุฐู ููุชููู ุจูุง ูุณุงูุ', answer: 'ุงููุงุชู' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุง ููุงู ูููู ูุณุชุฑุฎูุ', answer: 'ุงูุณูุงุก' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูููุณุฑ ุนูุฏ ุฐูุฑูุ', answer: 'ุงูุณููุช' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุถุญู ุจูุง ุตูุชุ', answer: 'ุงูุงุจุชุณุงูุฉ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ููุดู ุจูุง ุฃุฑุฌูุ', answer: 'ุงูููุช' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุฐูุจ ุจุนูุฏูุง ููู ูุนูุฏ ูู ุงูููุงูุฉุ', answer: 'ุงูููุช' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูู ุฃุณูุงู ูููู ูุง ูุฃููุ', answer: 'ุงููุดุท' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุฒุฏุงุฏ ูููุง ููุช ุจุชูููููุ', answer: 'ุงูุนูุฑ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุนูุด ูู ุงูุจุญุฑ ููุชููุณ ุชุญุช ุงููุงุกุ', answer: 'ุงูุณููุฉ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุญูู ุงูููุงูุจ ูุงููุฌููุ', answer: 'ุงููุถุงุก' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุง ูุชุบูุฑ ููููุ', answer: 'ุงูุธู' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุง ูููู ููุณูุ', answer: 'ุงูููุงุก' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุชุจุนู ุฃูููุง ุฐูุจุชุ', answer: 'ุงูุธู' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูููู ูู ุฌูุจู ููุญุจ ุงูุฏูุกุ', answer: 'ุงูุจุทุงูุฉ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุง ูููู ุดุฑุงุคูุ', answer: 'ุงูุณุนุงุฏุฉ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุฎููู ุงูุฌููุนุ', answer: 'ุงูุฃุณุฑุงุฑ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุฃุชู ูุจู ุงูุดูุณุ', answer: 'ุงููุฌุฑ' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุง ูููู ุฑุคูุชู ุจุงูุนูู ุงููุฌุฑุฏุฉุ', answer: 'ุงูููุงุก' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุญูุธ ุงูุฃุณุฑุงุฑุ', answer: 'ุงูุตูุฏูู' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ููููู ุฃู ุชุฃุฎุฐู ูููู ูุง ููููู ุงุณุชุฑุฌุงุนูุ', answer: 'ุงููููุงุช' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุถูุก ูู ุงูุธูุงูุ', answer: 'ุงููุฌู' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ูุทูุฑ ุจุฏูู ุฃุฌูุญุฉุ', answer: 'ุงูุฎูุงู' },
    { question: 'ูุง ูู ุงูุดูุก ุงูุฐู ููุชูู ูู ููุงู ูุขุฎุฑ ุฏูู ุฃู ูุชุญุฑูุ', answer: 'ุงูุฃููุงุฑ' },
];

export async function handler(m, { command, text, conn }) {
    let id = m.chat;

    conn.millionGame = conn.millionGame || {};

    let currentGame = conn.millionGame[id];

    if (!currentGame) {
        if (!text) {
            let currentLevel = 1;
            startNewQuestion(conn, m, id, currentLevel);
        } else {
            m.react('๐๐ป');
            conn.sendButton(m.chat, `> *ูุนุจุฉ ุฌุฏูุฏุฉ ูุฏ ุจุฏุฃุช.*`, null, null, [[`โฌ ุงูุณุคุงู`, `.ูุฒูุฑู`]], null, null);
        }
        return;
    }

    const currentQuestion = currentGame[1]; // ุงุณุชุฑุฌุงุน ุงูุณุคุงู ุงูุญุงูู

    if (text === currentQuestion.answer) {
        m.react('โ');
        let currentLevel = currentGame[4];
        let points = basePoints * currentLevel;

        // ูุธุงู ููุงูุฃุฉ ุงูุณุฑุนุฉ
        let timeTaken = gameDuration - (Date.now() - currentGame[2].startTime);
        let speedBonus = Math.max(0, Math.floor((timeTaken / 1000) * 50)); // ููุงูุฃุฉ ุงูุณุฑุนุฉ
        let totalPoints = points + speedBonus;

        global.db.data.users[m.sender].exp += totalPoints;

        conn.sendButton(m.chat, `> *๐ ูุจุฑูู! ููุฏ ุฑุจุญุช ${totalPoints} ููุทุฉ (ุจูุง ูู ุฐูู ${speedBonus} ููุงูุฃุฉ ุงูุณุฑุนุฉ)! ุงููุณุชูู ุงูุญุงูู: ${currentLevel}*`, null, null, [[`โฌ ุงูุณุคุงู ุงูุชุงูู`, `.ูุฒูุฑู`]], null, null);
        
        // ุงูุชุฃูุฏ ูู ูุณุชูู ุงูุชูุฏู
        if (currentLevel === 5 || currentLevel === 10) {
            conn.reply(m.chat, `> ๐ ูุจุฑูู! ููุฏ ูุตูุช ุฅูู ุงููุณุชูู ${currentLevel} ูุญุตูุช ุนูู ููุงูุฃุฉ ุฅุถุงููุฉ!`, m);
            global.db.data.users[m.sender].exp += 1000; // ุฅุถุงูุฉ ููุงูุฃุฉ 1000 ููุทุฉ
        }

        clearTimeout(currentGame[3]);
        currentLevel++;

        
if (currentLevel > maxQuestions) {
            conn.reply(m.chat, '> *๐ ูุจุฑูู! ููุฏ ุฑุจุญุช !*', m);
            delete conn.millionGame[id];
        } else {
            startNewQuestion(conn, m, id, currentLevel);
        }

    } else if (text === "ุงูุณุญุงุจ") {
        m.react('โ');
        conn.sendButton(m.chat, `> *ููุฏ ุงูุณุญุจุช ูู ุงููุนุจุฉ!*`, null, null, [[`โฌ ูุนุจุฉ ุฌุฏูุฏุฉ`, `.ูุฒูุฑู`]], null, null);
        delete conn.millionGame[id]; // ุฅููุงุก ุงููุนุจุฉ
    } else {
        m.react('โ');
        conn.sendButton(m.chat, `> *โ ุงูุฅุฌุงุจุฉ ุฎุงุทุฆุฉ. ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูุงูุช: ${currentQuestion.answer}*`, null, null, [[`โฌ ูุนุจุฉ ุฌุฏูุฏุฉ`, `.ูุฒูุฑู`]], null, null);
        delete conn.millionGame[id];
    }
}

// ุฏุงูุฉ ุจุฏุก ุงูุณุคุงู ุงูุฌุฏูุฏ
async function startNewQuestion(conn, m, id, level) {
    const question = tips[Math.floor(Math.random() * tips.length)];
    
    conn.millionGame[id] = [m, question, { startTime: Date.now() }, setTimeout(() => {
        delete conn.millionGame[id];
        conn.sendButton(m.chat, `> * ุงูููุช ุฎูุต ูุงูุช ูุณู ูุญูุงู ูุฌูุจุชุด ๐น ุงูุงุฌุงุจู ๐๐ป ${question.answer} *`, null, null, [[`โฌ ูุนุจุฉ ุฌุฏูุฏุฉ`, `.ูุฒูุฑู`]], null, null);
    }, gameDuration), level];

    // ุฅูุดุงุก ุฎูุงุฑุงุช ูุน 3 ุฅุฌุงุจุงุช
    const correctAnswer = question.answer;
    const wrongAnswers = tips
        .filter(t => t.answer !== correctAnswer) // ุงุณุชุจุนุงุฏ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ
        .sort(() => 0.5 - Math.random()) // ุฎูุท ุงูุฅุฌุงุจุงุช
        .slice(0, 2) // ุงุฎุชูุงุฑ ุฅุฌุงุจุชูู ุฎุงุทุฆุชูู
        .map(t => t.answer); // ุงุณุชุฎุฑุงุฌ ุงูุฅุฌุงุจุงุช

    const options = [correctAnswer, ...wrongAnswers].sort(() => Math.random() - 0.5); // ุฎูุท ุงูุฎูุงุฑุงุช

    let message = `
> *ุงูุณุคุงู: ${question.question}*
> *ููุช ุงูุฅุฌุงุจุฉ: ${(gameDuration / 1000).toFixed(2)} ุซูุงูู*
> *ุงูุฌุงุฆุฒุฉ: ${basePoints * level} ููุทุฉ*
> *ุฏูุณ ุน ุฒุฑ ุงูุณุญุจ ูู ูุด ุนุงุฑู ุงูุงุฌุงุจู*

> *\`ใ ๐๐๐๐๐๐-๐๐๐ ใ\`*
`;

    await conn.sendButton(m.chat, message, null, null, [
        [` ${options[0]}`, `.ูุฒูุฑู ${options[0]}`],
        [` ${options[1]}`, `.ูุฒูุฑู ${options[1]}`],
        [` ${options[2]}`, `.ูุฒูุฑู ${options[2]}`],
        [`ุงูุณุญุงุจ`, `.ูุฒูุฑู ุงูุณุญุงุจ`] // ุฒุฑ ุงูุงูุณุญุงุจ
    ], null, null);
}

handler.help = ['ูุฒูุฑู'];
handler.tags = ['ุงูุนุงุจ'];
handler.command = /^ูุฒูุฑู$/i;

export default handler;