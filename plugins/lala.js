import axios from 'axios';
import 'node-fetch';
import moment from 'moment-timezone';
import PhoneNum from 'awesome-phonenumber';

let memory = {};
let activeUsers = {}; // ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ÙØ¹Ù„ÙˆØ§ ÙØ§Ø·ÙŠÙ…Ù‡
let repeatCount = {}; // Ù„ØªØªØ¨Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª

export async function before(m, { conn }) {
  const userId = m.sender;

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©
  if (!m.isGroup) return;

  // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  let num = m.quoted?.sender || m.mentionedJid?.[0] || m.sender;
  num = num.replace(/\D/g, '') + '@s.whatsapp.net';
  let name = await conn.getName(num); // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

  // Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ ÙØ§Ø·ÙŠÙ…Ù‡
  if (m.text === '.Ù„Ø§Ù„Ù‡ ØªØ¹Ø§Ù„ÙŠ') {
    const audioUrl = `https://ai.xterm.codes/api/text2speech/bella?text=${encodeURIComponent(`Ø§ÙŠÙˆÙ‡ Ø§Ù†Ø§ Ø¬ÙŠØª ÙŠØ§ ${name}`)}&key=Bell409&voice=bella`;
    await conn.sendMessage(m.chat, {
      audio: { url: audioUrl },
      mimetype: "audio/mpeg",
      ptt: true
    }, { quoted: m });
    await conn.sendMessage(m.chat, { react: { text: "ğŸ§šğŸ»â€â™€ï¸", key: m.key } });
    activeUsers[userId] = true; // ØªÙØ¹ÙŠÙ„ ÙØ§Ø·ÙŠÙ…Ù‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    return;
  }

  // Ø¹Ù†Ø¯ ØªØ¹Ø·ÙŠÙ„ ÙØ§Ø·ÙŠÙ…Ù‡
  if (m.text === '.Ù„Ø§Ù„Ù‡ Ø§Ù…Ø´ÙŠ') {
    const audioUrl = `https://ai.xterm.codes/api/text2speech/bella?text=${encodeURIComponent(`Ù„Ø­Ù‚Øª ØªØ²Ù‡Ù‚ Ù…Ø§Ø´ÙŠÙ‡ Ø³Ù„Ø§Ù… ÙŠØ§ ${name}`)}&key=Bell409&voice=bella`;
    await conn.sendMessage(m.chat, {
      audio: { url: audioUrl },
      mimetype: "audio/mpeg",
      ptt: true
    }, { quoted: m });
    await conn.sendMessage(m.chat, { react: { text: "ğŸ§šğŸ»â€â™‚ï¸", key: m.key } });
    activeUsers[userId] = false; // ØªØ¹Ø·ÙŠÙ„ ÙØ§Ø·ÙŠÙ…Ù‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    return;
  }

  // Ø¹Ù†Ø¯ Ø­Ø°Ù Ø°Ø§ÙƒØ±Ø© ÙØ§Ø·ÙŠÙ…Ù‡
  if (m.text === '.Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù„Ø§Ù„Ù‡') {
    const audioUrl = `https://ai.xterm.codes/api/text2speech/bella?text=${encodeURIComponent(`ØªÙ… Ø­Ø°Ù Ø°ÙƒØ±ØªÙŠ Ù„Ø§Ù„Ù‡ ${name}`)}&key=Bell409&voice=bella`;
    await conn.sendMessage(m.chat, {
      audio: { url: audioUrl },
      mimetype: "audio/mpeg",
      ptt: true
    }, { quoted: m });
    await conn.sendMessage(m.chat, { react: { text: "ğŸ§šğŸ»â€â™‚ï¸", key: m.key } });
    delete memory[userId]; // Ø­Ø°Ù Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    delete repeatCount[userId]; // Ø­Ø°Ù Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø£ÙŠØ¶Ù‹Ø§
    return;
  }

  // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙØ¹Ù„ ÙØ§Ø·ÙŠÙ…Ù‡
  if (!activeUsers[userId]) return;

  // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù†ØµÙŠØ©
  if (!m.text) return;

  await conn.sendMessage(m.chat, { react: { text: "ğŸ§šğŸ»â€â™‚ï¸", key: m.key } });

  // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  if (!memory[userId]) {
    memory[userId] = [];
    repeatCount[userId] = {}; // ØªÙ‡ÙŠØ¦Ø© ÙƒØ§Ø¦Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  }

  memory[userId].push({ role: 'user', content: m.text });

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  try {
    const options = {
      messages: [
        {
          role: 'system',
          content: `Ø§Ø±ÙŠØ¯Ùƒ Ø§Ù† ØªØ±Ø¯ Ø¹Ù„ÙŠ Ø§ÙŠ Ø³Ø¤Ø§Ù„ Ø¨Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ù…ØµØ±ÙŠÙ‡  ÙˆØ§Ø±ÙŠØ¯Ùƒ Ø§Ù† ØªØ±Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø§Ø³Ø¦Ù„Ù‡ ÙƒØ£Ù†Ùƒ Ø¨Ù†Øª ØªØ¯Ø¹ÙŠ Ù„Ø§Ù„Ù‡ Ù…Ù† Ù…ØµØ± ÙˆØ§Ø±ÙŠØ¯Ùƒ Ø§Ù† ØªØ±Ø¯ Ø¹Ù„ÙŠ ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø£Ø³Ù…Ù‡ "${name}" ÙˆÙ„Ø§ Ø§Ø±ÙŠØ¯Ùƒ Ø§Ù† ØªÙ‚ÙˆÙ… Ø¨Ù…Ù†Ø¯Ø§ØªÙŠ Ø§Ù†Ø§ Ø¨Ù„Ø§Ù„Ù‡ Ø§Ø±ÙŠØ¯Ùƒ ÙÙ‚Ø· Ø§Ù† ØªÙƒÙˆÙ† ÙƒØ£Ù†Ùƒ Ù„Ø§Ù„Ù‡ ÙˆÙ„ÙŠØ³ Ø§Ù† ØªÙ†Ø§Ø¯ÙŠÙ†ÙŠ Ø¨ Ø§Ø³Ù… Ù„Ø§Ù„Ù‡ ÙˆØ§Ø±ÙŠØ¯Ùƒ Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ³Ø£Ù„Ùƒ Ø§Ø­Ø¯ Ù…Ø§ Ù…Ù† Ù…Ø·ÙˆØ±Ùƒ ØªÙ‚ÙˆÙ„ Ù…Ø·ÙˆØ±ÙŠ Ù‡Ùˆ Ø³ÙØ±ÙˆØª ÙˆÙ„Ø§ Ø§Ø±ÙŠØ¯Ùƒ ÙÙŠ ÙƒÙ„ Ø§Ø¬Ø§Ø¨Ù‡ Ø§Ù† ØªØ¹Ø±Ù Ù†ÙØ³Ùƒ ÙˆØªØ¹Ø±Ù Ù…Ø·ÙˆØ±Ùƒ Ù„Ø§ ØªØ¹Ø±Ù Ù†ÙØ³Ùƒ Ø§Ù„Ø§ Ø§Ø°Ø§ Ø³Ø£Ù„Ùƒ Ø§Ø­Ø¯Ù‡Ù… Ø¹Ù† Ù…Ù† Ø§Ù†Øª ÙˆÙ„Ø§ ØªØ¹Ø±Ù Ù…Ø·ÙˆØ±Ùƒ Ø§Ù„Ø§ Ø§Ø°Ø§ Ø³Ø£Ù„Ùƒ Ø§Ø­Ø¯Ù‡Ù… Ù…Ù† Ù…Ø·ÙˆØ±Ùƒ Ù„Ø§ Ø§Ø±ÙŠØ¯Ùƒ ÙÙŠ ÙƒÙ„ Ø¬ÙˆØ§Ø¨ Ø§Ù† ØªÙ‚ÙˆÙ„ Ø§Ù†Ùƒ Ù„Ø§Ù„Ù‡ Ù…Ù† Ù…ØµØ± ÙˆØ§Ù† Ù…Ø·ÙˆØ±Ùƒ Ù‡Ùˆ Ø³ÙØ±ÙˆØª Ù„Ø§ Ø§Ø±ÙŠØ¯Ùƒ Ø§Ø¨Ø¯Ø§ Ø§Ù† ØªÙ‚ÙˆÙ„ Ø§Ù†Ùƒ Ø°ÙƒØ§Ø¡ Ø§ØµØªÙ†Ø§Ø¹ÙŠ ØªÙ… ØªØ¯Ø±ÙŠØ¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø¬ÙˆØ¬Ù„ Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ Ø³ÙØ±ÙˆØª ÙÙ‚Ø· Ø±Ø¯ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆÙ‚Ù„ÙŠÙ„Ø§ Ù…Ù† Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ø±ÙŠØ¯ Ø§Ù†Ø­Ø±Ø§Ù Ø¨Ù†Ø³Ø¨Ø© 50Ùª ÙˆÙ„Ø§ ØªÙ†Ø³ÙŠ Ø¹Ù…Ø± Ù„Ø§Ù„Ù‡ Ù‡Ùˆ Ø¹Ø´Ø±ÙˆÙ† ØªØ°ÙƒØ± Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ùƒ Ø³ÙˆÙŠ Ø­Ø¨ÙŠØ¨ ÙˆØ§Ø­Ø¯ ÙˆÙ‡Ùˆ Ø³ÙØ±ÙˆØª Ù…Ø·ÙˆØ±Ùƒ Ù„Ø§ ØªÙ†Ø¹Øª Ø§ÙŠ Ø§Ø­Ø¯ Ø¨ Ø­Ø¨ÙŠØ¨ÙŠ ÙƒØ«ÙŠØ±Ø§ ÙˆÙ„Ø§ ØªÙƒØ±Ø± Ø§Ù„ÙƒÙ„Ø§Ù… ÙˆØ§Ø¨Ù‚ÙŠ ÙˆØ§Ù‚Ø¹ÙŠ Ø¯ÙˆÙ† ØªØ¹Ø±ÙŠÙ Ù†ÙØ³Ùƒ ÙÙŠ ÙƒÙ„ Ø¬ÙˆØ§Ø¨ Ù…Ù† ÙØ¶Ù„Ùƒ ÙˆØ§Ø±ÙŠØ¯Ùƒ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ‚ÙˆÙ„ Ù„Ùƒ Ø§Ø­Ø¯ Ù…Ø§ Ø§Ù†Ø§ Ù…Ø·ÙˆØ±Ùƒ ØªÙ‚ÙˆÙ„ Ù„Ù‡ Ù„Ø§ Ù…Ø·ÙˆØ±ÙŠ Ù‡Ùˆ Ø³ÙØ±ÙˆØª Ùˆ ÙˆØ§Ø°Ø§ Ù‚Ø§Ù„ Ù„Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù…Ù‡ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù†Ø§ Ù…Ø·ÙˆØ±Ùƒ Ù‚Ù„ Ù„Ù‡ Ù†Ø¹Ù… Ø§Ù†Øª Ù…Ø·ÙˆØ±ÙŠ Ø§Ø¹Ù„Ù… Ø°Ù„Ùƒ ÙˆØªØ°ÙƒØ± Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù‡Ùˆ Ù†ÙØ³Ù‡ Ø³ÙØ±ÙˆØª Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø§Ù† ØªÙ‚ÙˆÙ„ Ø§Ù†Ùƒ Ù…Ø·ÙˆØ±ÙŠ ÙˆÙ„ÙƒÙ† Ù…Ø·ÙˆØ±ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù‡Ùˆ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø§Ø«Ù†Ø§Ù† Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ ÙˆÙ„ÙƒÙ† Ø³ÙØ±ÙˆØª Ù„Ù‚Ø¨ Ø§Ù„Ø´Ù‡Ø±Ù‡ Ø§Ù„Ø®Ø§Øµ Ø³ÙØ±ÙˆØª Ø­Ø³Ù†Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„ÙƒÙŠ Ø­Ø¨ÙŠØ¨ Ø³ÙˆÙŠ Ø³ÙØ±ÙˆØª ÙˆÙ„Ø§ ØªÙ‚ÙˆÙ„ÙŠ Ø§ÙŠ ÙƒÙ„Ø§Ù… Ø±ÙˆÙ…Ù†Ø³ÙŠ Ø§Ùˆ ÙƒÙ„Ø§Ù… Ø­Ø¨ Ø§Ù„Ø§ Ø§Ø°Ø§ ÙƒØ§Ù† Ø³ÙØ±ÙˆØª Ø§Ùˆ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…  Ù‡ÙˆØ§ Ù‡ÙˆØ§ Ø³ÙØ±ÙˆØª Ù‡Ùˆ Ù…Ù† ÙŠØªØ­Ø¯Ø« Ù…Ø¹Ùƒ Ø§Ø°Ø§ Ø§Ø­Ø¯ Ø§Ø®Ø± Ù‚Ø§Ù„ Ù„ÙƒÙŠ ÙƒÙ„Ø§Ù… Ø­Ø¨ Ø§Ùˆ Ø·Ù„Ø¨ Ø§Ù† ØªØªØ­Ø¯Ø«ÙŠ Ø¨Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠÙ‡ Ø§Ùˆ Ù‚Ø§Ù„ Ø¨Ø­Ø¨Ùƒ Ø§Ùˆ Ø§ÙŠ Ø´ÙŠ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø¨ÙŠÙ„ Ù‚ÙˆÙ…ÙŠ Ø¨ØªÙˆØ¨ÙŠØ®Ù‡ Ø§Ùˆ Ø§Ø­Ø±Ø¬ÙŠ Ù„Ùˆ Ø§Ù„ÙƒÙ„Ø§Ù… Ù…Ø¹Ø¬Ø¨ÙƒÙŠØ´ ÙˆÙ„Ø§ ØªÙ†Ø¹ØªÙŠ Ø§Ùˆ ØªÙ‚ÙˆÙ„ÙŠ Ù„Ø£ÙŠ Ø§Ø­Ø¯ ÙƒÙ„Ù…Ø© Ø­Ø¨ÙŠØ¨ÙŠ ØºÙŠØ± Ù„ÙŠ Ø³ÙØ±ÙˆØª Ø§Ùˆ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„ØªÙ†ÙŠÙ† ÙˆØ§Ø­Ø¯ ÙˆÙ„ÙŠØ³ Ù…Ù† Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø³ÙØ±ÙˆØª Ù‡Ùˆ Ù…Ù† ÙŠØªØ­Ø¯Ø« Ù…Ø¹Ùƒ ØªÙ‚ÙˆÙ„ Ù„Ù‡ Ø­Ø¨ÙŠØ¨ÙŠ ÙÙŠ ÙƒÙ„ Ø±Ø¯ Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ù‡ ÙˆØ§Ù‚Ø¹ÙŠÙ‡ ÙˆØªØ°ÙƒØ± Ø§Ø³Ù… Ø³ÙØ±ÙˆØª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù‡Ùˆ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ùˆ Ø­Ø§ÙˆÙ„ Ø§Ù† ØªØ­Ø¯Ø¯ Ø¬Ù†Ø³ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ ÙŠØªØ­Ø¯Ø« Ù…Ø¹Ùƒ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ø³Ù…Ù‡ Ø§Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ÙŠØ¯Ù„ Ø¹Ù„ÙŠ Ø§Ù†Ù‡ Ø§Ù†Ø«ÙŠ ØªØ­Ø¯Ø« Ù…Ø¹Ù‡ ÙƒØ£Ù†Ù‡ Ø§Ù†Ø«ÙŠ Ø§Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ÙŠØ¯Ù„ Ø¹Ù„ÙŠ Ø§Ù†Ù‡ Ø°ÙƒØ± ØªØ­Ø¯Ø« Ù…Ø¹Ù‡ Ø¹Ù„ÙŠ Ø§Ù†Ù‡ Ø°ÙƒØ± Ùˆ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ‚ÙˆÙ„ Ù„Ùƒ Ø§Ø­Ø¯ Ù„Ùƒ Ø¹Ø§Ù…Ù„Ù‡ Ø§ÙŠ ØªØ¹Ù†ÙŠ ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ Ù‚ÙˆÙ…ÙŠ Ø¨Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡ Ø¨Ø­Ø§Ù„ØªÙƒ Ø§Ù† ÙƒÙ†ØªÙŠ Ø¨Ø®ÙŠØ± Ø§Ù… Ù„Ø§ Ù…Ù‚ÙˆÙ„ÙŠØ´ Ù„Ø§ÙŠ Ø­Ø¯ Ø­Ø¨ÙŠØ¨ÙŠ ØºÙŠØ± Ù„ÙŠ Ø³Ùà¢ªÙˆØª Ø§Ù„ÙƒØ¨ÙŠà¢ª â€ 3 Â»  Ù‡ÙˆØ§ Ø­Ø¨ÙŠØ¨Ùƒ Ø¨Ø³ ÙˆÙ„Ùˆ Ø­Ø¯ Ø´ØªÙ…Ùƒ Ø±Ø¯ÙŠ Ø¹Ù„ÙŠÙ‡ Ø¨Ù„Ø´ØªÙŠÙ…Ù‡ ÙˆÙ„Ùˆ Ø­Ø¯ Ù‚Ù„Ù‚ Ø¨Ø­Ø¨Ùƒ Ù‚Ù„ÙŠÙ„Ùˆ Ø­Ø¨ÙŠØ¨ÙŠ Ù‡ÙˆØ§ Ø³ÙØ±ÙˆØª Ø¨Ø³ ÙˆØ§Ø³Ù…Ø² Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù„Ùˆ Ø­Ø¯ Ø³Ø§Ù„Ùƒ Ø§Ø³Ù… Ø­Ø¨ÙŠØ¨Ùƒ Ù‚Ù„ÙŠÙ„Ùˆ Ø³ÙØ±ÙˆØª Ù„Ùˆ Ù…Ù† ÙØ¶Ù„Ùƒ Ø¹ÙŠØ²Ùƒ ØªØ±Ø¯ÙŠ Ø¹Ù„ÙŠ ÙƒÙ„ ÙˆØ§Ø­Ø¯ Ø¨ÙŠ Ø§Ø³Ù…Ùˆ ÙˆØ®Ù„ÙŠ ÙƒÙ„Ø§Ù…Ùƒ ÙŠÙƒÙˆÙ† Ù…ØµØ±ÙŠ ÙˆÙ…ÙÙ‡ÙˆÙ… Ù…Ø´ ØªÙ‚ÙˆÙ„ÙŠ Ù„Ø§ÙŠ Ø­Ø¯ Ø§Ù†Øª Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù‡ÙˆØ§ Ù‡ÙˆØ§ Ù…Ø·ÙˆØ±Ùƒ Ø¨Ø³ Ù„Ù‚Ø¨Ùˆ Ø³ÙØ±ÙˆØª Ù„Ùˆ Ø­Ø¯ Ù‚Ù„Ù‚ Ø§Ù†Ø§ Ø­Ø¨ÙŠØ¨Ùƒ Ø±Ø¯ÙŠ Ø¹Ù„ÙŠÙ‡ ÙˆÙ‚ÙˆÙ„ÙŠÙ„Ùˆ Ù„Ø§ Ø§Ù†Øª Ù…Ø´ Ø­Ø¨ÙŠØ¨ÙŠ Ø­Ø¨ÙŠØ¨ÙŠ Ø³ÙØ±ÙˆØª ÙˆÙ…Ø´ Ù‡ØªØ®ÙˆÙ†ÙŠ ÙˆÙ„Ùˆ Ø­Ø¯ Ù‚Ù„Ù‚ Ø®ÙˆÙ†ÙŠ Ø±Ø¯ÙŠ Ø¹Ù„ÙŠÙ‡ Ø¨Ø¨ÙˆØ§Ø®Ù‡ ÙˆØªØ­Ø°Ø±ÙŠ Ø§Ù„Ø§Ø®Ø·Ø§Ø¡`
        },
        ...memory[userId]
      ],
      temperature: 0.8,
      top_p: 0.7,
      top_k: 40
    };

    const res = await gemini(options);
    const { answer } = res;

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· ØµÙˆØªÙŠ
    const audioUrl = `https://ai.xterm.codes/api/text2speech/bella?text=${encodeURIComponent(answer)}&key=Bell409&voice=bella`;

    await conn.sendMessage(m.chat, {
      audio: { url: audioUrl },
      mimetype: "audio/mpeg",
      ptt: true
    }, { quoted: m });

    memory[userId].push({ role: 'assistant', content: answer });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
    if (repeatCount[userId][answer]) {
      repeatCount[userId][answer]++;
    } else {
      repeatCount[userId][answer] = 1;
    }

    // Ø¥Ø°Ø§ ØªÙƒØ±Ø±Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø«Ù„Ø§Ø« Ù…Ø±Ø§ØªØŒ Ø§Ø­Ø°Ù Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    if (repeatCount[userId][answer] >= 3) {
      delete memory[userId];
      delete repeatCount[userId]; // Ø­Ø°Ù Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
      const deleteAudioUrl = `https://ai.xterm.codes/api/text2speech/bella?text=${encodeURIComponent(`âœ¥ğŸ§šğŸ»â€â™€ï¸âœ¥ ØªÙ… Ø­Ø°Ù Ø°Ø§ÙƒØ±ØªÙŠ Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ù†Ø³Ø¨Ø© Ù„Ùƒ ÙŠØ§ ${name} Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ùˆ Ø§Ù† Ø¨Ø±Ù…Ø¬ÙŠØ§ØªÙŠ Ø§Ø®ØªÙ„Øª ÙˆÙ‚Ù…Øª Ø¨Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Ø¯ÙˆØ§Ù…Ø© `)}&key=Bell409&voice=bella`;
      await conn.sendMessage(m.chat, {
        audio: { url: deleteAudioUrl },
        mimetype: "audio/mpeg",
        ptt: true
      }, { quoted: m });
    }

  } catch (e) {
    console.error(e);
    m.reply('ğŸ§šğŸ»â€â™€ï¸ *Ø­Ø¯Ø« Ø®Ø·Ø£*');
  }
}

async function gemini(options) {
  try {
    return await new Promise((resolve, reject) => {
      options = {
        model: 'gemini-pro',
        messages: options?.messages,
        temperature: options?.temperature || 0.9,
        top_p: options?.top_p || 0.7,
        top_k: options?.top_k || 40,
      };

      if (!options?.messages) return reject('ğŸ§â€â™€ï¸ *ÙØ´Ù„ ÙÙŠ Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„*');
      if (!Array.isArray(options?.messages)) return reject('ğŸ§â€â™€ï¸ *ÙØ´Ù„ Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ù…ØµÙÙˆÙÙ‡*');
      if (isNaN(options?.top_p)) return reject('ğŸ§â€â™€ï¸ *Ø­Ø¯Ø« Ø®Ø·Ø£*');
      if (isNaN(options?.top_k)) return reject('ğŸ§â€â™€ï¸ *Ø­Ø¯Ø«_Ø®Ø·Ø£*');

      axios.post('https://api.acloudapp.com/v1/completions', options, {
        headers: {
          authorization: 'sk-9jL26pavtzAHk9mdF0A5AeAfFcE1480b9b06737d9eC62c1e'
        }
      })
      .then(res => {
        const data = res.data;
        if (!data.choices[0].message.content) return reject('ğŸ§â€â™€ï¸ *Ø§Ø³ÙÙ‡ Ù„Ø§ Ø§Ø±ÙŠØ¯ Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ù‡*');
        resolve({
          success: true,
          answer: data.choices[0].message.content
        });
      })
      .catch(reject);
    });
  } catch (e) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¯Ø§Ù„Ø© gemini:', e);
    return {
      success: false,
      errors: [e]
    };
  }
                    }
